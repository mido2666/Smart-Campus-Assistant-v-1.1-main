import { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { BookOpen, AlertCircle, Loader2, UserPlus, X } from 'lucide-react';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';
import { FormField } from '../components/ui/FormField';
import { useFormValidation } from '../hooks/useFormValidation';
import { validators, inputMasks } from '../utils/validation';
import SkipToContent from '../components/SkipToContent';
import { apiClient } from '../services/api';

export default function Login() {
  const navigate = useNavigate();
  const location = useLocation();
  const { login, logout, isLoading, error, clearError, user, isAuthenticated } = useAuth();
  const { theme: savedTheme, setTheme } = useTheme();

  const [role, setRole] = useState<'student' | 'professor'>('student');
  const [localError, setLocalError] = useState('');
  const [rememberMe, setRememberMe] = useState<boolean>(false);
  const [showRegisterForm, setShowRegisterForm] = useState(false);
  const [isRegistering, setIsRegistering] = useState(false);
  const [registerSuccess, setRegisterSuccess] = useState(false);

  const {
    values,
    errors,
    touched,
    isSubmitting,
    isValid,
    handleChange,
    handleBlur,
    handleSubmit,
    getFieldError,
  } = useFormValidation({
    initialValues: {
      universityId: '',
      password: '',
    },
    validationRules: {
      universityId: [
        validators.required('University ID is required'),
        validators.universityId('University ID must be exactly 8 digits'),
      ],
      password: [
        validators.required('Password is required'),
        validators.password('Password must be at least 6 characters'),
      ],
    },
    onSubmit: async (values) => {
      try {
        if (rememberMe) {
          localStorage.setItem('login.rememberMe', 'true');
          localStorage.setItem('login.universityId', values.universityId);
        } else {
          localStorage.removeItem('login.rememberMe');
          localStorage.removeItem('login.universityId');
        }
        await login(values.universityId, values.password);
      } catch (err: any) {
        const errorMsg = err?.response?.data?.message || err?.message || 'Invalid University ID or Password';
        setLocalError(errorMsg);
        throw err;
      }
    },
  });

  // Force light mode on Login page - prevent dark mode completely
  // But save the original theme to restore it after login
  useEffect(() => {
    // Save the current theme before forcing light mode
    // Check both localStorage and ThemeContext state to get the most accurate value
    const storedTheme = localStorage.getItem('theme');
    const originalTheme = storedTheme || (savedTheme === 'dark' ? 'dark' : 'light');
    
    // Ensure localStorage has the correct theme value
    if (!storedTheme && savedTheme) {
      localStorage.setItem('theme', savedTheme);
    }
    
    // Remove dark mode from document immediately
    document.documentElement.classList.remove('dark');
    document.body.classList.remove('dark');
    
    // Create observer to prevent dark mode from being added by ThemeContext or other sources
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const target = mutation.target as HTMLElement;
          if (target.classList.contains('dark')) {
            target.classList.remove('dark');
          }
        }
      });
    });
    
    // Observe document and body for class changes
    observer.observe(document.documentElement, { 
      attributes: true, 
      attributeFilter: ['class'],
      attributeOldValue: false
    });
    observer.observe(document.body, { 
      attributes: true, 
      attributeFilter: ['class'],
      attributeOldValue: false
    });
    
    // Also prevent ThemeContext from changing theme while on login page
    // Use a more efficient interval (500ms instead of 100ms)
    const preventDarkMode = () => {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
      }
      if (document.body.classList.contains('dark')) {
        document.body.classList.remove('dark');
      }
    };
    
    // Check periodically to ensure dark mode stays disabled
    const interval = setInterval(preventDarkMode, 500);
    
    // Store original theme for cleanup
    const originalThemeRef = { value: originalTheme };
    
    return () => {
      observer.disconnect();
      clearInterval(interval);
      
      // Restore original theme when leaving login page
      // Use a longer delay to ensure navigation completed and new page components mounted
      const restoreTheme = () => {
        const storedTheme = localStorage.getItem('theme') || originalThemeRef.value;
        if (storedTheme === 'dark') {
          // Apply dark mode immediately to DOM
          document.documentElement.classList.add('dark');
          document.body.classList.add('dark');
          // Update ThemeContext state
          setTheme('dark');
        } else {
          // Ensure light mode
          document.documentElement.classList.remove('dark');
          document.body.classList.remove('dark');
          setTheme('light');
        }
      };
      
      // Restore theme after a short delay to ensure navigation completed
      setTimeout(restoreTheme, 200);
    };
  }, [savedTheme, setTheme]);

  useEffect(() => {
    const remembered = localStorage.getItem('login.rememberMe') === 'true';
    const savedId = localStorage.getItem('login.universityId') || '';
    if (remembered && savedId) {
      setRememberMe(true);
      handleChange('universityId', savedId);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    const validateAndRedirect = async () => {
      if (isAuthenticated && user) {
        const userRole = user.role.toLowerCase();
        const selectedRole = role.toLowerCase();

        if (selectedRole === 'student' && userRole !== 'student') {
          setLocalError('You are not registered as a student. Please select the correct role.');
          await logout();
          return;
        }
        if (selectedRole === 'professor' && userRole !== 'professor' && userRole !== 'admin') {
          setLocalError('You are not registered as a professor. Please select the correct role.');
          await logout();
          return;
        }

        // Restore theme before navigation to ensure it's applied correctly
        // Get the saved theme from localStorage (should be preserved from before login)
        const savedTheme = localStorage.getItem('theme') || 'light';
        
        // Apply theme immediately before navigation
        if (savedTheme === 'dark') {
          setTheme('dark');
          // Also apply directly to DOM to ensure it's visible immediately
          document.documentElement.classList.add('dark');
          document.body.classList.add('dark');
        } else {
          setTheme('light');
          document.documentElement.classList.remove('dark');
          document.body.classList.remove('dark');
        }

        // Small delay to ensure theme is applied before navigation
        await new Promise(resolve => setTimeout(resolve, 100));

        if (userRole === 'student') {
          navigate('/student-dashboard', { replace: true });
        } else if (userRole === 'professor' || userRole === 'admin') {
          navigate('/professor-dashboard', { replace: true });
        }
      }
    };
    validateAndRedirect();
  }, [isAuthenticated, user, navigate, role, logout, setTheme]);

  const displayError = localError || error;
  const hasFormErrors = Object.keys(errors).length > 0;
  const hasAnyError = !!(displayError || hasFormErrors);

  return (
    <>
      <SkipToContent targetId="main-content" />
      <div className="min-h-screen bg-gray-50 flex transition-colors duration-200">
      <div className="hidden lg:flex lg:w-1/2 bg-gray-50 items-center justify-center p-12 transition-colors duration-200">
        <div className="max-w-lg">
          <img
            src="/src/assets/2.png"
            alt="Smart Campus Illustration"
            className="w-full h-auto image-rendering-high-quality"
          />
        </div>
      </div>

      <div className="w-full lg:w-1/2 flex items-center justify-center p-8">
        <main id="main-content" className="w-full max-w-md" aria-labelledby="login-title" tabIndex={-1}>
          <div className="bg-white rounded-2xl shadow-xl p-8 md:p-10 transition-colors duration-200">
            <div className="text-center mb-8">
              <div className="flex items-center justify-center gap-3 mb-3">
                <BookOpen className="w-12 h-12 text-blue-600" strokeWidth={2} />
                <h1 id="login-title" className="text-3xl font-bold text-gray-900 transition-colors duration-200">
                  Smart Campus<br />Assistant
                </h1>
              </div>
            </div>

            <div className="flex border-b-2 border-gray-200 mb-8 transition-colors duration-200" role="tablist" aria-label="Select role">
              <button
                role="tab"
                aria-selected={role === 'student'}
                aria-controls="login-form"
                tabIndex={role === 'student' ? 0 : -1}
                onKeyDown={(e) => {
                  if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    setRole(role === 'student' ? 'professor' : 'student');
                  }
                }}
                onClick={() => setRole('student')}
                className={`flex-1 pb-3 text-base font-medium transition-colors relative focus:outline-none rounded-t ${
                  role === 'student'
                    ? 'text-blue-600'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Student
                {role === 'student' && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600" />}
              </button>
              <button
                role="tab"
                aria-selected={role === 'professor'}
                aria-controls="login-form"
                tabIndex={role === 'professor' ? 0 : -1}
                onKeyDown={(e) => {
                  if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    setRole(role === 'student' ? 'professor' : 'student');
                  }
                }}
                onClick={() => setRole('professor')}
                className={`flex-1 pb-3 text-base font-medium transition-colors relative focus:outline-none rounded-t ${
                  role === 'professor'
                    ? 'text-blue-600'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Professor
                {role === 'professor' && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-blue-600" />}
              </button>
            </div>

            <form id="login-form" onSubmit={handleSubmit} className="space-y-6" noValidate aria-label="Login form">
              <fieldset className="space-y-5">
                <legend className="sr-only">Login form fields</legend>
              {/* Error Summary */}
              {hasAnyError && (
                <div 
                  className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3" 
                  role="alert"
                  aria-live="polite"
                  aria-atomic="true"
                >
                  <AlertCircle className="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" aria-hidden="true" />
                  <div>
                    {displayError && (
                      <p className="text-sm text-red-800 font-medium">{displayError}</p>
                    )}
                    {hasFormErrors && !displayError && (
                      <div>
                        <p className="text-sm text-red-800 font-medium mb-2">
                          Please fix the following errors:
                        </p>
                        <ul className="mt-1 space-y-1 text-xs text-red-700 list-disc list-inside">
                          {Object.entries(errors).map(([field, error]) => (
                            <li key={field}>{error}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                </div>
              )}

              <FormField
                label="University ID"
                name="universityId"
                type="text"
                value={values.universityId}
                onChange={(value) => {
                  handleChange('universityId', value);
                  if (displayError) {
                    setLocalError('');
                    clearError();
                  }
                }}
                onBlur={() => handleBlur('universityId')}
                placeholder="Enter 8-digit ID (e.g., 12345678)"
                autoComplete="username"
                inputMode="numeric"
                mask={inputMasks.universityId}
                error={getFieldError('universityId')}
                touched={touched.universityId}
                disabled={isLoading || isSubmitting}
                required
                helperText="Your 8-digit university identification number"
              />

              <FormField
                label="Password"
                name="password"
                type="password"
                value={values.password}
                onChange={(value) => {
                  handleChange('password', value);
                  if (displayError) {
                    setLocalError('');
                    clearError();
                  }
                }}
                onBlur={() => handleBlur('password')}
                placeholder="Enter your password"
                autoComplete="current-password"
                showPasswordToggle
                error={getFieldError('password')}
                touched={touched.password}
                disabled={isLoading || isSubmitting}
                required
                helperText="Enter your password (minimum 6 characters)"
              />

              <div className="flex items-center justify-between">
                <label className="inline-flex items-center gap-2 text-sm text-gray-600">
                  <input
                    type="checkbox"
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    checked={rememberMe}
                    onChange={(e) => setRememberMe(e.target.checked)}
                    disabled={isLoading}
                  />
                  Remember me
                </label>

                <a
                  href="#"
                  className="text-sm text-gray-600 hover:text-gray-800 transition-colors"
                >
                  Forgot password?
                </a>
              </div>

              <button
                type="submit"
                disabled={isLoading || isSubmitting || !isValid}
                className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white font-semibold py-3.5 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-sm flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                aria-label={isLoading || isSubmitting ? 'Signing in, please wait' : 'Sign in to Smart Campus Assistant'}
              >
                {isLoading || isSubmitting ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" aria-hidden="true" />
                    Signing in...
                  </>
                ) : (
                  'Login'
                )}
              </button>
              </fieldset>
            </form>

            <div className="mt-6 text-center">
              {!showRegisterForm ? (
                <button
                  type="button"
                  onClick={() => setShowRegisterForm(true)}
                  className="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700 font-medium transition-colors duration-200"
                >
                  <UserPlus className="w-4 h-4" />
                  Create Account
                </button>
              ) : (
                <button
                  type="button"
                  onClick={() => {
                    setShowRegisterForm(false);
                    setRegisterSuccess(false);
                    setLocalError('');
                  }}
                  className="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-700 transition-colors duration-200"
                >
                  <X className="w-4 h-4" />
                  Back to Login
                </button>
              )}
            </div>

            {showRegisterForm && (
              <div className="mt-8">
                <RegisterForm 
                  role={role}
                  onSuccess={() => {
                    setRegisterSuccess(true);
                    setLocalError('');
                    setTimeout(() => {
                      setShowRegisterForm(false);
                      setRegisterSuccess(false);
                    }, 3000);
                  }}
                  onError={(error) => setLocalError(error)}
                  isSubmitting={isRegistering}
                  setIsSubmitting={setIsRegistering}
                />
              </div>
            )}

            {registerSuccess && (
              <div className="mt-6 bg-green-50 border-2 border-green-300 rounded-lg p-5 text-center animate-in fade-in slide-in-from-top-2 duration-300">
                <p className="text-base text-green-800 font-semibold flex items-center justify-center gap-2">
                  <span className="text-xl">âœ“</span>
                  Account created successfully! You can now login.
                </p>
              </div>
            )}

            <div className="mt-4 text-center">
              <p className="text-sm text-gray-500 transition-colors duration-200">
                Smart Campus Assistant 0.2025
              </p>
            </div>
          </div>
        </main>
      </div>
    </div>
    </>
  );
}

// Register Form Component
interface RegisterFormProps {
  role: 'student' | 'professor';
  onSuccess: () => void;
  onError: (error: string) => void;
  isSubmitting: boolean;
  setIsSubmitting: (value: boolean) => void;
}

function RegisterForm({ role, onSuccess, onError, isSubmitting, setIsSubmitting }: RegisterFormProps) {
  const {
    values,
    errors,
    touched,
    isValid,
    handleChange,
    handleBlur,
    handleSubmit,
    getFieldError,
    reset
  } = useFormValidation({
    initialValues: {
      name: '',
      universityId: '',
      email: '',
      password: '',
      confirmPassword: '',
    },
    validationRules: {
      name: [
        validators.required('Name is required'),
        validators.minLength(2, 'Name must be at least 2 characters'),
      ],
      universityId: [
        validators.required('University ID is required'),
      ],
      email: [
        validators.required('Email is required'),
        validators.email('Please enter a valid email address'),
      ],
      password: [
        validators.required('Password is required'),
        validators.minLength(6, 'Password must be at least 6 characters'),
      ],
      confirmPassword: [
        validators.required('Please confirm your password'),
      ],
    },
    onSubmit: async (values) => {
      setIsSubmitting(true);
      try {
        // Validate password match
        if (values.password !== values.confirmPassword) {
          throw new Error('Passwords do not match');
        }

        // Get the exact universityId value from form state
        // IMPORTANT: This value should already have mask applied (digits only, max 8)
        const universityIdFromForm = values.universityId || '';
        
        // Log form state before processing
        console.log('ðŸ“‹ Frontend - Form state values:', {
          allValues: values,
          universityIdInForm: universityIdFromForm,
          universityIdType: typeof universityIdFromForm,
          universityIdLength: universityIdFromForm?.length
        });
        
        // Convert to string and trim ONLY - DO NOT modify the value further
        // The mask already processed it, so we just need to ensure it's a clean string
        const universityIdToSend = String(universityIdFromForm).trim();
        
        if (!universityIdToSend || universityIdToSend.length === 0) {
          throw new Error('University ID is required');
        }
        
        // Parse name into firstName and lastName
        const nameParts = values.name.trim().split(/\s+/);
        const firstName = nameParts[0] || '';
        // If only one name provided, use it for both (some cultures use single names)
        // Otherwise, join all remaining parts as last name
        const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : firstName;
        
        if (!firstName) {
          throw new Error('Please enter your name');
        }
        
        // Prepare registration data
        const registrationData = {
          firstName: firstName,
          lastName: lastName,
          universityId: universityIdToSend, // Send EXACT value (already masked in form)
          email: values.email.trim(),
          password: values.password,
          role: role, // Use the selected role from the UI
        };
        
        // Final check before sending
        console.log('ðŸ“¤ Frontend - FINAL data being sent to backend:', registrationData);
        
        const response = await apiClient.post('/auth/register', registrationData);

        // Check if response indicates failure (even if no exception thrown)
        if (!response.success) {
          const errorMessage = response.message || 'Registration failed. Please try again.';
          onError(errorMessage);
          return; // Don't proceed
        }

        // Success case
        onSuccess();
        reset(); // Clear form after successful registration
      } catch (error: any) {
        // Extract error message from different possible error structures
        let errorMessage = 'Registration failed. Please try again.';
        
        // Priority 1: Check if it's a response object with success:false (from updated apiClient)
        if (error?.success === false && error?.message) {
          errorMessage = error.message;
        }
        // Priority 2: Check if error has response data (from axios/old apiClient)
        else if (error?.response?.data?.message) {
          errorMessage = error.response.data.message;
        } 
        // Priority 3: Check if error message is directly in error object
        else if (error?.message) {
          errorMessage = error.message;
        }
        // Priority 4: Check if error has data property directly
        else if (error?.data?.message) {
          errorMessage = error.data.message;
        }
        
        console.log('[RegisterForm] Registration error:', {
          error,
          errorMessage,
          errorStructure: {
            hasResponse: !!error?.response,
            hasMessage: !!error?.message,
            hasData: !!error?.data,
            responseData: error?.response?.data
          }
        });
        
        onError(errorMessage);
      } finally {
        setIsSubmitting(false);
      }
    },
  });

  // Custom validation for password match
  const passwordMatchError = touched.confirmPassword && values.confirmPassword && values.password !== values.confirmPassword
    ? 'Passwords do not match'
    : null;

  return (
    <div className="mt-8 pt-6 border-t border-gray-200">
      <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
        Create New Account
      </h2>
      
      <form onSubmit={handleSubmit} className="space-y-5">
        <FormField
          label="Full Name"
          name="name"
          type="text"
          value={values.name}
          onChange={(value) => handleChange('name', value)}
          onBlur={() => handleBlur('name')}
          placeholder="Enter your full name"
          autoComplete="name"
          error={getFieldError('name')}
          touched={touched.name}
          disabled={isSubmitting}
          required
        />

        <FormField
          label="University ID"
          name="universityId"
          type="text"
          value={values.universityId}
          onChange={(value) => {
            // Log the value received from FormField (after mask)
            console.log('ðŸŽ¯ RegisterForm - University ID onChange:', {
              rawValue: value,
              valueType: typeof value,
              valueLength: value?.length
            });
            handleChange('universityId', value);
          }}
          onBlur={() => handleBlur('universityId')}
          placeholder="Enter your University ID (e.g., 20221245)"
          autoComplete="username"
          inputMode="numeric"
          mask={inputMasks.universityId}
          error={getFieldError('universityId')}
          touched={touched.universityId}
          disabled={isSubmitting}
          required
          helperText="Enter your 8-digit university identification number"
        />

        <FormField
          label="Email"
          name="email"
          type="email"
          value={values.email}
          onChange={(value) => handleChange('email', value)}
          onBlur={() => handleBlur('email')}
          placeholder="Enter your email address"
          autoComplete="email"
          error={getFieldError('email')}
          touched={touched.email}
          disabled={isSubmitting}
          required
        />

        <FormField
          label="Password"
          name="password"
          type="password"
          value={values.password}
          onChange={(value) => handleChange('password', value)}
          onBlur={() => handleBlur('password')}
          placeholder="Enter password (min 6 characters)"
          autoComplete="new-password"
          showPasswordToggle
          error={getFieldError('password')}
          touched={touched.password}
          disabled={isSubmitting}
          required
          helperText="Password must be at least 6 characters long"
        />

        <FormField
          label="Confirm Password"
          name="confirmPassword"
          type="password"
          value={values.confirmPassword}
          onChange={(value) => handleChange('confirmPassword', value)}
          onBlur={() => handleBlur('confirmPassword')}
          placeholder="Confirm your password"
          autoComplete="new-password"
          showPasswordToggle
          error={passwordMatchError || getFieldError('confirmPassword')}
          touched={touched.confirmPassword}
          disabled={isSubmitting}
          required
        />

        <button
          type="submit"
          disabled={isSubmitting || !isValid || passwordMatchError !== null}
          className="w-full bg-green-600 hover:bg-green-700 disabled:bg-green-400 disabled:cursor-not-allowed text-white font-semibold py-3.5 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-sm flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
        >
          {isSubmitting ? (
            <>
              <Loader2 className="w-5 h-5 animate-spin" />
              Creating Account...
            </>
          ) : (
            <>
              <UserPlus className="w-5 h-5" />
              Create Account
            </>
          )}
        </button>
      </form>
    </div>
  );
}
