# ุฅุตูุงุญ ูุดููุฉ Refresh Token - 401 Unauthorized

## ๐ ููุฎุต ุงููุดููุฉ

ูุงูุช ุงููุดููุฉ ุชุชูุซู ูู ุฃู ูุธุงู ุงูู refresh tokens ูู ููู ูุทุจูุงู ุจุดูู ุตุญูุญ:
- ุงูู backend ูุงู ูุฑุณู `mock-refresh-token` ุจุฏูุงู ูู tokens ุญููููุฉ
- ูู ููู ููุงู ุฌุฏูู `RefreshToken` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูู ููู ููุงู ุญูู `tokenVersion` ูู ุฌุฏูู `users`

## โ ุงูุชุบููุฑุงุช ุงูุชู ุชู ุฅุฌุฑุงุคูุง

### 1. ุชุญุฏูุซุงุช ูู Schema.prisma

ุชู ุฅุถุงูุฉ:
- ูููุฐุฌ `RefreshToken` ูุชุฎุฒูู refresh tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุญูู `tokenVersion` ูู ูููุฐุฌ `User` ูุฅุฏุงุฑุฉ ุตูุงุญูุฉ ุงูู tokens

### 2. ุชุญุฏูุซุงุช ูู AuthService

ุชู ุชุญุฏูุซ `src/services/auth.service.ts`:
- ุงุณุชุจุฏุงู Map ูู ุงูุฐุงูุฑุฉ ุจุชุฎุฒูู tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุญุฏูุซ `refreshToken()` method ูุงุณุชุฎุฏุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุญุฏูุซ `logout()` method ูุญุฐู tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุญุฏูุซ `generateTokens()` method ูุญูุธ tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 3. Prisma Client

ุชู ุชูููุฏ Prisma Client ุงูุฌุฏูุฏ ุจูุฌุงุญ ููุชุถูู ูููุฐุฌ RefreshToken.

## ๐ ุฎุทูุงุช ุชุทุจูู ุงูุชุบููุฑุงุช

### ุงูุฎุทูุฉ 1: ุชุฃูุฏ ูู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช PostgreSQL ุชุนูู

```bash
# ุชุดุบูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅุฐุง ููุช ุชุณุชุฎุฏู Docker
npm run db:start

# ุฃู ุชุฃูุฏ ูู ุฃู PostgreSQL ูุนูู ุนูู localhost:5432
```

### ุงูุฎุทูุฉ 2: ุชุทุจูู Migration ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุทุฑููุฉ ุงูุฃููู: ุจุงุณุชุฎุฏุงู Prisma Migrate (ููุตู ุจูุง)**

```bash
npx prisma migrate dev --name add_refresh_token_and_token_version
```

**ุงูุทุฑููุฉ ุงูุซุงููุฉ: ุชุทุจูู SQL ูุฏููุงู**

ุฅุฐุง ูู ุชูุฌุญ ุงูุทุฑููุฉ ุงูุฃูููุ ุงุณุชุฎุฏู SQL ุงููุฑูู:

```bash
# ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
psql -U postgres -d smart_campus_dev

# ุชุดุบูู ููู SQL
\i prisma/migrations/manual_migration_refresh_token.sql

# ุฃู ูุณุฎ ูุญุชูู ุงูููู ูุชูููุฐู ูุจุงุดุฑุฉ
```

### ุงูุฎุทูุฉ 3: ุฅุนุงุฏุฉ ุชุดุบูู ุงูู Backend

```bash
npm run server:dev
# ุฃู
npm run server
```

### ุงูุฎุทูุฉ 4: ุงุฎุชุจุงุฑ ุงููุธุงู

1. ุณุฌู ุฏุฎูู ุฅูู ุงูุชุทุจูู
2. ุชุญูู ูู ุฃู access token ูุนูู ุจุดูู ุตุญูุญ
3. ุนูุฏูุง ููุชูู access tokenุ ูุฌุจ ุฃู ูุชู ุชุญุฏูุซู ุชููุงุฆูุงู ุจุงุณุชุฎุฏุงู refresh token
4. ูุง ูุฌุจ ุฃู ุชุฑู ุฃุฎุทุงุก 401 Unauthorized ุจุนุฏ ุงูุขู

## ๐ ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุบููุฑุงุช

### ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
-- ุชุญูู ูู ูุฌูุฏ ุฌุฏูู refresh_tokens
SELECT * FROM refresh_tokens LIMIT 5;

-- ุชุญูู ูู ูุฌูุฏ ุญูู tokenVersion ูู users
SELECT id, "universityId", email, "tokenVersion" FROM users LIMIT 5;
```

### ูุญุต ุงูู Logs

ุนูุฏ ุชุณุฌูู ุงูุฏุฎููุ ูุฌุจ ุฃู ุชุฑู:
```
[AuthService] Login successful for user: 12345678
[AuthService] New tokens generated successfully
```

ุนูุฏ ุชุญุฏูุซ tokenุ ูุฌุจ ุฃู ุชุฑู:
```
[AuthService] Refresh token request received
[AuthService] JWT verification successful, userId: 1
[AuthService] User found: 1 12345678
[AuthService] New tokens generated successfully
```

## ๐ ูููุงุช SQL ููุชุทุจูู ุงููุฏูู

ุฅุฐุง ุงุญุชุฌุช ูุชุทุจูู Migration ูุฏููุงูุ ุงุณุชุฎุฏู ุงูููู:
```
prisma/migrations/manual_migration_refresh_token.sql
```

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุชุฃุซูุฑ ุนูู ุงููุณุชุฎุฏููู ุงูุญุงูููู**: ุฌููุน ุงููุณุชุฎุฏููู ุงูุญุงูููู ุณูุญุชุงุฌูู ูุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ุชุทุจูู Migration
2. **Tokens ุงููุฏููุฉ**: ุฃู tokens ููุฌูุฏุฉ ุญุงููุงู ูู localStorage ุณุชุตุจุญ ุบูุฑ ุตุงูุญุฉ
3. **ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุชุฃูุฏ ูู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุตูุฉ ูุจู ุฅุนุงุฏุฉ ุชุดุบูู ุงูู Backend

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ: "P1000: Authentication failed"
**ุงูุญู**: ุชุฃูุฏ ูู ุฃู ุจูุงูุงุช ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุตุญูุญุฉ ูู ููู `.env`:
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/smart_campus_dev"
```

### ุฎุทุฃ: "RefreshToken model not found"
**ุงูุญู**: ุฃุนุฏ ุชูููุฏ Prisma Client:
```bash
npx prisma generate
```

### ุฎุทุฃ: "Invalid refresh token"
**ุงูุญู**: ูู ุจูุณุญ localStorage ูุณุฌู ุฏุฎูู ูู ุฌุฏูุฏ:
```javascript
// ูู console ุงููุชุตูุญ
localStorage.clear();
location.reload();
```

### ุฎุทุฃ: "Token refresh failed: PrismaClientValidationError"
**ุงูุญู**: ุชุฃูุฏ ูู ุชุทุจูู Migration ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฅุนุงุฏุฉ ุชุดุบูู ุงูู Backend

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงููุ ุชุญูู ูู:
1. ุงูู Backend logs ูู terminal
2. ุงูู Browser console ููุฃุฎุทุงุก ูู Frontend
3. ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุฌูุฏ ุงูุฌุฏุงูู ุงููุทููุจุฉ

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูููู ุจูุงุณุทุฉ**: AI Assistant  
**ุงูุชุงุฑูุฎ**: 2025-11-03  
**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุชุทุจูู

